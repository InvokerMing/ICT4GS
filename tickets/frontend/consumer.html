<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo City Attractions - Online Ticketing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Basic view switching */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Card and input styles (similar to previous version) */
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #4a5568;
        }

        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .input-field:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3);
        }

        .quantity-input {
            width: 70px;
            text-align: center;
        }

        /* Specific style for quantity */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4299e1;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal Styles*/
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #qrcode {
            margin: 15px auto;
            width: 200px;
            height: 200px;
        }

        #qrcode img {
            display: block;
            margin: auto;
        }

        /* Tooltip Styles*/
        .tooltip-trigger {
            display: inline-block;
            margin-left: 5px;
            cursor: pointer;
            color: #667eea;
            border: 1px solid #cbd5e0;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #2d3748;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 135%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.4;
            pointer-events: none;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2d3748 transparent transparent transparent;
        }

        .tooltip-trigger:hover .tooltip-text,
        .tooltip-trigger:focus .tooltip-text,
        .tooltip-trigger.active .tooltip-text {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        /* Language switcher style*/
        .lang-switcher button {
            padding: 4px 8px;
            margin: 0 3px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
        }

        .lang-switcher button.active {
            background-color: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        /* Attraction Detail Styles */
        #attraction-detail-view img {
            max-height: 300px;
            object-fit: cover;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 p-4 md:p-8">

    <div class="lang-switcher text-right mb-4 mr-2 fixed top-2 right-2 z-50">
        <button id="lang-en" onclick="setLanguage('en')">English</button>
        <button id="lang-zh" onclick="setLanguage('zh')">中文</button>
    </div>

    <div class="container mx-auto max-w-6xl bg-white p-6 rounded-lg shadow-md">

        <div id="attraction-list-view" class="view active">
            <h1 id="main-title" class="text-3xl font-bold text-center text-gray-800 mb-8">Solo City Attractions Online
                Ticketing</h1>
            <div id="attractions-loading" class="text-center py-10">
                <div class="spinner"></div>
                <p id="loading-text" class="text-gray-500">Loading attraction information...</p>
            </div>
            <div id="attractions-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 hidden">
            </div>
            <div id="attractions-error" class="text-center text-red-600 font-medium mb-4 hidden"></div>
        </div>

        <div id="attraction-detail-view" class="view">
            <button onclick="showView('attraction-list-view')" class="mb-4 text-blue-600 hover:underline">&larr; <span
                    class="back-to-list-text">Back to List</span></button>
            <div id="detail-content">
            </div>
            <div id="detail-error" class="text-center text-red-600 font-medium mb-4 hidden"></div>
        </div>

        <div id="purchase-view" class="view">
            <button onclick="showView('attraction-detail-view', currentAttractionId)"
                class="mb-4 text-blue-600 hover:underline">&larr; <span class="back-to-detail-text">Back to
                    Details</span></button>
            <h2 id="purchase-title" class="text-2xl font-semibold mb-4">Book Tickets for: <span
                    id="purchase-attraction-name"></span></h2>
            <form id="purchase-form" onsubmit="handleProceedToPayment(event)">
                <div class="mb-4 p-4 border rounded bg-gray-50">
                    <h3 class="text-lg font-medium mb-3"><span class="ticket-selection-title">Ticket Selection</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <label for="quantity-full" class="mb-0 ticket-type-full-label">Full Price Ticket:</label>
                            <input type="number" id="quantity-full" name="quantity_full" value="1" min="0" max="10"
                                class="input-field quantity-input mb-0" oninput="updatePurchaseSummary()">
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="quantity-discount" class="mb-0 ticket-type-discount-label">
                                Discount Ticket (50%):
                                <span class="tooltip-trigger" tabindex="0" onclick="toggleTooltip(this)"
                                    onmouseenter="showTooltip(this)" onmouseleave="hideTooltip(this)"
                                    onfocus="showTooltip(this)" onblur="hideTooltip(this)">?
                                    <span class="tooltip-text tooltip-discount-text">Eligible: Students, Seniors (60+),
                                        Children (under 12). Proof may be required.</span>
                                </span>
                            </label>
                            <input type="number" id="quantity-discount" name="quantity_discount" value="0" min="0"
                                max="10" class="input-field quantity-input mb-0" oninput="updatePurchaseSummary()">
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="quantity-free" class="mb-0 ticket-type-free-label">
                                Free Ticket:
                                <span class="tooltip-trigger" tabindex="0" onclick="toggleTooltip(this)"
                                    onmouseenter="showTooltip(this)" onmouseleave="hideTooltip(this)"
                                    onfocus="showTooltip(this)" onblur="hideTooltip(this)">?
                                    <span class="tooltip-text tooltip-free-text">Eligible: Infants (under 2), Specific
                                        promotions. Check details.</span>
                                </span>
                            </label>
                            <input type="number" id="quantity-free" name="quantity_free" value="0" min="0" max="10"
                                class="input-field quantity-input mb-0" oninput="updatePurchaseSummary()">
                        </div>
                    </div>
                </div>

                <div id="purchase-name-fields" class="mb-4 p-4 border rounded">
                    <h3 class="text-lg font-medium mb-3"><span class="attendee-info-title">Attendee Information</span>
                        (<span id="total-tickets-count">1</span> <span class="attendees-label">attendee(s)</span>)</h3>
                </div>

                <div class="mb-4 p-4 border rounded bg-gray-50">
                    <label for="purchase-email"><span class="email-label">Email:</span></label>
                    <input type="email" id="purchase-email" name="customer_email" required class="input-field">

                    <label for="purchase-usage-date"><span class="usage-date-label">Usage Date:</span></label>
                    <input type="date" id="purchase-usage-date" name="usage_date" required
                        onchange="validateUsageDate(this)" class="input-field">
                </div>

                <div class="text-right font-semibold my-4 text-xl">
                    <span class="total-price-label">Estimated Total:</span> <span id="purchase-total-price">Rp 0</span>
                </div>

                <button type="submit" id="proceed-to-payment-btn"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg shadow transition duration-300 text-lg">
                    <span class="proceed-payment-btn-text">Proceed to Payment (Simulation)</span>
                </button>
            </form>
            <div id="purchase-error" class="text-center text-red-600 font-medium mt-4 hidden"></div>
        </div>

        <div id="message" class="text-center text-green-600 font-medium mb-4 min-h-[1.5em]"></div>
        <div id="error-message" class="text-center text-red-600 font-medium mb-4 min-h-[1.5em]"></div>

    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title" class="text-2xl font-semibold mb-4 text-green-600">Purchase Successful!</h2>
            <p id="modal-order-label" class="mb-2">Your Order ID is:</p>
            <p id="modalOrderId" class="text-xl font-bold mb-4"></p>
            <p id="modal-qr-label" class="mb-3">Please use the QR code below for entry:</p>
            <div id="qrcode"></div>
            <p id="modal-email-info" class="text-sm text-gray-500 mt-4">Details have been sent to your email
                (simulation).</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000/api';

        // --- Translations ---
        const translations = {
            en: {
                title: "Solo City Attractions - Online Ticketing",
                mainTitle: "Solo City Attractions Online Ticketing",
                loadingText: "Loading attraction information...",
                noAttractions: "No attractions available for booking currently.",
                loadError: "Failed to load attractions:",
                detailLoadError: "Failed to load attraction details:",
                datePastError: "Date must be today or later.",
                basePriceLabel: "Base Price:",
                pricePending: "Free or Price TBD",
                noDesc: "No detailed description available.",
                bookNowButton: "Book Now",
                backToList: "Back to List",
                backToDetail: "Back to Details",
                purchaseTitle: "Book Tickets for:",
                ticketSelectionTitle: "Ticket Selection",
                ticketTypeFullLabel: "Full Price Ticket:",
                ticketTypeDiscountLabel: "Discount Ticket (50%):",
                ticketTypeFreeLabel: "Free Ticket:",
                attendeeInfoTitle: "Attendee Information",
                attendeesLabel: "attendee(s)",
                nameLabel: "Name", // Numbered
                emailLabel: "Email:",
                usageDateLabel: "Usage Date:",
                totalPriceLabel: "Estimated Total:",
                proceedPaymentBtnText: "Proceed to Payment (Simulation)",
                purchaseButtonLoading: "Processing...",
                fillFieldsError: "Please fill in all required fields",
                fillNamesError: "Please enter names for all attendees",
                quantityError: "Total quantity must be between 1 and 10",
                purchaseSuccess: "Purchase successful! Order ID:",
                purchaseFail: "Purchase failed:",
                modalTitle: "Purchase Successful!",
                modalOrderLabel: "Your Order ID is:",
                modalQrLabel: "Please use the QR code below for entry:",
                modalEmailInfo: "Details have been sent to your email (simulation).",
                tooltipDiscount: "Eligible: Students, Seniors (60+), Children (under 12). Proof may be required.",
                tooltipFree: "Eligible: Infants (under 2), Specific promotions. Check details.",
            },
            zh: {
                title: "梭罗市景点票务 - 在线购票",
                mainTitle: "梭罗市景点在线票务",
                loadingText: "正在加载景点信息...",
                noAttractions: "暂无可售票的景点。",
                loadError: "加载景点列表失败:",
                detailLoadError: "加载景点详情失败:",
                datePastError: "日期必须是今天或更晚。",
                basePriceLabel: "基础价格:",
                pricePending: "免费或价格待定",
                noDesc: "暂无详细描述。",
                bookNowButton: "立即预订",
                backToList: "返回列表",
                backToDetail: "返回详情",
                purchaseTitle: "预订门票:",
                ticketSelectionTitle: "选择票种和数量",
                ticketTypeFullLabel: "全价票:",
                ticketTypeDiscountLabel: "优惠票 (50%):",
                ticketTypeFreeLabel: "免费票:",
                attendeeInfoTitle: "游客信息",
                attendeesLabel: "位游客",
                nameLabel: "姓名", // Numbered
                emailLabel: "邮箱:",
                usageDateLabel: "使用日期:",
                totalPriceLabel: "预计总价:",
                proceedPaymentBtnText: "确认订单 (模拟支付)",
                purchaseButtonLoading: "处理中...",
                fillFieldsError: "请填写所有必填项",
                fillNamesError: "请输入所有游客的姓名",
                quantityError: "总票数必须在 1 到 10 之间",
                purchaseSuccess: "购买成功！订单号:",
                purchaseFail: "购买失败:",
                modalTitle: "购买成功!",
                modalOrderLabel: "您的订单号是:",
                modalQrLabel: "请使用下方二维码入场:",
                modalEmailInfo: "详细信息已发送至您的邮箱 (模拟)。",
                tooltipDiscount: "适用人群：学生、老年人（60岁以上）、儿童（12岁以下）。可能需要证件。",
                tooltipFree: "适用人群：婴幼儿（2岁以下）、特定活动。请查看详情。",
            }
        };
        let currentLang = 'en';
        let currentAttractionId = null; // Store ID of attraction being booked
        let currentAttractionBasePrice = 0; // Store base price for calculation

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const attractionListView = document.getElementById('attraction-list-view');
        const attractionDetailView = document.getElementById('attraction-detail-view');
        const purchaseView = document.getElementById('purchase-view');
        const attractionsGrid = document.getElementById('attractions-grid');
        const attractionsLoadingDiv = document.getElementById('attractions-loading');
        const attractionsErrorDiv = document.getElementById('attractions-error');
        const detailContent = document.getElementById('detail-content');
        const detailError = document.getElementById('detail-error');
        const purchaseForm = document.getElementById('purchase-form');
        const purchaseAttractionName = document.getElementById('purchase-attraction-name');
        const purchaseNameFieldsContainer = document.getElementById('purchase-name-fields');
        const purchaseTotalPrice = document.getElementById('purchase-total-price');
        const totalTicketsCountSpan = document.getElementById('total-tickets-count');
        const purchaseErrorDiv = document.getElementById('purchase-error');
        const proceedBtn = document.getElementById('proceed-to-payment-btn');
        const messageDiv = document.getElementById('message'); // Shared message divs
        const errorMessageDiv = document.getElementById('error-message');
        const successModal = document.getElementById('successModal');
        const modalOrderId = document.getElementById('modalOrderId');
        const qrCodeContainer = document.getElementById('qrcode');
        const pageTitle = document.querySelector('title');
        const mainTitle = document.getElementById('main-title');
        const loadingText = document.getElementById('loading-text');
        const modalTitle = document.getElementById('modal-title');
        const modalOrderLabel = document.getElementById('modal-order-label');
        const modalQrLabel = document.getElementById('modal-qr-label');
        const modalEmailInfo = document.getElementById('modal-email-info');
        const langEnBtn = document.getElementById('lang-en');
        const langZhBtn = document.getElementById('lang-zh');

        // --- Helper Functions ---
        function validateUsageDate(input) {
            const selectedDate = input.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0);

            if (selected < today) {
                showError(translations[currentLang].datePastError); // Show general error
                input.value = ''; // Clear the invalid date
                return false;
            }
            clearMessages(errorMessageDiv); // Clear general error if date is valid
            return true;
        }
        function showMessage(msg) {clearMessages(); messageDiv.textContent = msg; setTimeout(clearMessages, 5000); }
        function showError(msg, target = errorMessageDiv) {clearMessages(); target.textContent = msg; target.classList.remove('hidden'); setTimeout(() => clearMessages(target), 7000); }
        function clearMessages(target = null) { 
            if (target) { target.textContent = ''; target.classList.add('hidden'); }
            else {
                messageDiv.textContent = ''; errorMessageDiv.textContent = ''; errorMessageDiv.classList.add('hidden');
                attractionsErrorDiv.textContent = ''; attractionsErrorDiv.classList.add('hidden');
                detailError.textContent = ''; detailError.classList.add('hidden');
                purchaseErrorDiv.textContent = ''; purchaseErrorDiv.classList.add('hidden');
            }
        }
        function setLoadingState(button, isLoading, loadingTextKey = 'purchaseButtonLoading') { 
            if (button) {
                button.disabled = isLoading;
                if (isLoading) { button.dataset.originalText = button.textContent; button.textContent = translations[currentLang][loadingTextKey]; }
                else if (button.dataset.originalText) { button.textContent = button.dataset.originalText; }
            }
        }
        function openModal(orderId, qrData) { 
            modalOrderId.textContent = orderId; qrCodeContainer.innerHTML = '';
            new QRCode(qrCodeContainer, { text: qrData, width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
            successModal.style.display = "block";
        }
        function closeModal() {successModal.style.display = "none"; qrCodeContainer.innerHTML = ''; }
        window.onclick = function (event) { if (event.target == successModal) { closeModal(); } }
        function toggleTooltip(element) { element.classList.toggle('active'); }
        function showTooltip(element) { /* CSS handles this */ }
        function hideTooltip(element) { element.classList.remove('active'); }

        // --- View Management ---
        function showView(viewId, data = null) {
            clearMessages(); // Clear messages when changing views
            views.forEach(view => {
                view.classList.toggle('active', view.id === viewId);
            });
            // Scroll to top when changing views
            window.scrollTo(0, 0);

            // Load data if needed for the view
            if (viewId === 'attraction-detail-view' && data) {
                loadAttractionDetail(data); // data is attractionId
            } else if (viewId === 'purchase-view' && data) {
                setupPurchaseForm(data); // data is attraction object
            } else if (viewId === 'attraction-list-view') {
                // Optionally reload list if needed, or just show
                if (attractionsGrid.children.length === 0 && !attractionsLoadingDiv.classList.contains('active')) {
                    loadAttractionList(); // Reload if empty and not already loading
                }
            }
        }

        // --- Language Function ---
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('preferredLang', lang);
            document.documentElement.lang = lang;

            // Update static text
            pageTitle.textContent = translations[lang].title;
            mainTitle.textContent = translations[lang].mainTitle;
            loadingText.textContent = translations[lang].loadingText;
            modalTitle.textContent = translations[lang].modalTitle;
            modalOrderLabel.textContent = translations[lang].modalOrderLabel;
            modalQrLabel.textContent = translations[lang].modalQrLabel;
            modalEmailInfo.textContent = translations[lang].modalEmailInfo;
            document.querySelector('.back-to-list-text').textContent = translations[lang].backToList;
            document.querySelector('.back-to-detail-text').textContent = translations[lang].backToDetail;
            document.querySelector('.ticket-selection-title').textContent = translations[lang].ticketSelectionTitle;
            document.querySelector('.attendee-info-title').textContent = translations[lang].attendeeInfoTitle;
            document.querySelector('.attendees-label').textContent = translations[lang].attendeesLabel;
            document.querySelector('.email-label').textContent = translations[lang].emailLabel;
            document.querySelector('.usage-date-label').textContent = translations[lang].usageDateLabel;
            document.querySelector('.total-price-label').textContent = translations[lang].totalPriceLabel;
            document.querySelector('.proceed-payment-btn-text').textContent = translations[lang].proceedPaymentBtnText;
            // Update tooltip text dynamically (important!)
            document.querySelector('.tooltip-discount-text').innerHTML = `<b>${translations[lang].ticketTypeDiscountLabel.replace(':', '')}</b> ${translations[lang].tooltipDiscount}`;
            document.querySelector('.tooltip-free-text').innerHTML = `<b>${translations[lang].ticketTypeFreeLabel.replace(':', '')}</b> ${translations[lang].tooltipFree}`;


            langEnBtn.classList.toggle('active', lang === 'en');
            langZhBtn.classList.toggle('active', lang === 'zh');

            // Reload the current view to update dynamic content
            const activeView = document.querySelector('.view.active');
            if (activeView) {
                if (activeView.id === 'attraction-list-view') {
                    loadAttractionList();
                } else if (activeView.id === 'attraction-detail-view' && currentAttractionId) {
                    loadAttractionDetail(currentAttractionId);
                } else if (activeView.id === 'purchase-view' && currentAttractionId) {
                    // Need to refetch attraction details to update purchase form labels correctly
                    fetchAttractionData(currentAttractionId).then(attraction => {
                        if (attraction) setupPurchaseForm(attraction);
                    });
                }
            }
        }

        // --- Data Loading ---
        async function fetchAttractionData(attractionId) {
            try {
                const response = await fetch(`${API_BASE_URL}/attractions/${attractionId}?lang=${currentLang}`);
                if (!response.ok) { throw new Error(`HTTP ${response.status}`); }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching attraction ${attractionId}:`, error);
                return null; // Indicate failure
            }
        }

        async function loadAttractionList() {
            attractionsLoadingDiv.classList.remove('hidden');
            attractionsGrid.classList.add('hidden');
            attractionsErrorDiv.classList.add('hidden');
            loadingText.textContent = translations[currentLang].loadingText;

            try {
                const response = await fetch(`${API_BASE_URL}/attractions?lang=${currentLang}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Failed to load attractions (HTTP ${response.status})`);
                }
                const attractions = await response.json();

                attractionsGrid.innerHTML = '';
                if (attractions.length === 0) {
                    attractionsGrid.innerHTML = `<p class="text-center text-gray-500 col-span-1 sm:col-span-2 lg:col-span-3">${translations[currentLang].noAttractions}</p>`;
                } else {
                    attractions.forEach(attraction => {
                        const card = createAttractionListCard(attraction);
                        attractionsGrid.appendChild(card);
                    });
                }
                attractionsGrid.classList.remove('hidden');

            } catch (error) {
                console.error('Failed to load attractions:', error);
                const errorPrefix = translations[currentLang].loadError;
                showError(`${errorPrefix} ${error.message}`, attractionsErrorDiv);
            } finally {
                attractionsLoadingDiv.classList.add('hidden');
            }
        }

        function createAttractionListCard(attraction) {
            const card = document.createElement('div');
            // Use onclick to navigate to detail view
            card.className = 'p-0 border rounded-lg shadow bg-white card overflow-hidden'; // No padding, let image fill
            card.onclick = () => showView('attraction-detail-view', attraction.attraction_id);

            const imageUrl = attraction.image_url || 'https://placehold.co/600x400/cccccc/666666?text=Image+Not+Available';
            const priceFormatted = attraction.price > 0 ? `Rp ${attraction.price.toLocaleString('id-ID')}` : translations[currentLang].pricePending;

            card.innerHTML = `
                <img src="${imageUrl}" alt="${attraction.name}" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/600x400/cccccc/666666?text=Image+Error';">
                <div class="p-4">
                    <h3 class="text-lg font-semibold mb-1 text-gray-800 truncate">${attraction.name}</h3>
                    <p class="text-sm text-gray-600 mb-2 truncate">${attraction.description || translations[currentLang].noDesc}</p>
                    <p class="text-md font-bold text-blue-600">${priceFormatted}</p>
                </div>
            `;
            return card;
        }

        async function loadAttractionDetail(attractionId) {
            currentAttractionId = attractionId; // Store current ID
            detailContent.innerHTML = `<div class="spinner"></div><p>${translations[currentLang].loadingText}</p>`; // Show loading
            detailError.classList.add('hidden');

            const attraction = await fetchAttractionData(attractionId);

            if (attraction) {
                const imageUrl = attraction.image_url || 'https://placehold.co/800x400/cccccc/666666?text=Image+Not+Available';
                const priceFormatted = attraction.price > 0 ? `Rp ${attraction.price.toLocaleString('id-ID')}` : translations[currentLang].pricePending;
                currentAttractionBasePrice = attraction.price; // Store base price

                detailContent.innerHTML = `
                    <h2 class="text-3xl font-bold mb-3">${attraction.name}</h2>
                    <img src="${imageUrl}" alt="${attraction.name}" class="w-full object-cover rounded shadow mb-4" onerror="this.onerror=null; this.src='https://placehold.co/800x400/cccccc/666666?text=Image+Error';">
                    <p class="text-gray-700 mb-4">${attraction.description || translations[currentLang].noDesc}</p>
                    <p class="text-xl font-bold text-blue-600 mb-6"><span class="base-price-label">${translations[currentLang].basePriceLabel}</span> ${priceFormatted}</p>
                    <button onclick="showView('purchase-view', ${JSON.stringify(attraction).replace(/"/g, '&quot;')})" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg shadow text-lg transition duration-300">
                       <span class="book-now-button">${translations[currentLang].bookNowButton}</span>
                    </button>
                `;
            } else {
                const errorPrefix = translations[currentLang].detailLoadError;
                showError(`${errorPrefix} Attraction ID: ${attractionId}`, detailError);
                detailContent.innerHTML = ''; // Clear loading indicator
            }
        }

        // --- Purchase Form Logic ---
        function setupPurchaseForm(attraction) {
            currentAttractionId = attraction.attraction_id; // Ensure this is set
            currentAttractionBasePrice = parseFloat(attraction.price || 0);
            purchaseAttractionName.textContent = attraction.name;

            // Reset form fields to defaults
            purchaseForm.reset(); // Resets native form elements
            updatePurchaseSummary(); // Updates quantities, names, total price based on defaults
        }

        function updatePurchaseSummary() {
            const quantities = {
                full: parseInt(document.getElementById('quantity-full').value) || 0,
                discount: parseInt(document.getElementById('quantity-discount').value) || 0,
                free: parseInt(document.getElementById('quantity-free').value) || 0,
            };

            let totalQuantity = 0;
            let totalPrice = 0;

            // Recalculate total quantity and price
            for (const type in quantities) {
                let q = quantities[type];
                if (isNaN(q) || q < 0) q = 0;
                if (q > 10) q = 10; // Enforce max per type
                quantities[type] = q; // Update the value if corrected
                document.getElementById(`quantity-${type}`).value = q; // Reflect correction in UI
                totalQuantity += q;

                let multiplier = 1.0;
                if (type === 'discount') multiplier = 0.5;
                else if (type === 'free') multiplier = 0.0;
                totalPrice += q * currentAttractionBasePrice * multiplier;
            }

            // Enforce overall max quantity (e.g., if user enters 6 full, 6 discount)
            if (totalQuantity > 10) {
                // This case is tricky. How to reduce? Simplest is to show error and disable purchase.
                showError(translations[currentLang].quantityError, purchaseErrorDiv);
                proceedBtn.disabled = true;
                totalQuantity = 10; // Cap for display purposes
            } else {
                purchaseErrorDiv.classList.add('hidden'); // Clear error if valid
                proceedBtn.disabled = false;
            }


            // Update total tickets count display
            totalTicketsCountSpan.textContent = totalQuantity;

            // Update dynamic name fields
            updatePurchaseNameFields(totalQuantity);

            // Update total price display
            purchaseTotalPrice.textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
        }

        function updatePurchaseNameFields(totalQuantity) {
            purchaseNameFieldsContainer.innerHTML = ''; // Clear existing
            if (totalQuantity > 0 && totalQuantity <= 10) {
                const nameLabelBase = translations[currentLang].nameLabel;
                for (let i = 1; i <= totalQuantity; i++) {
                    const label = document.createElement('label');
                    label.htmlFor = `purchase_name_${i}`;
                    label.textContent = `${nameLabelBase} ${i}:`;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `purchase_name_${i}`;
                    input.name = `customer_name_${i}`;
                    input.className = 'input-field';
                    input.required = true;

                    purchaseNameFieldsContainer.appendChild(label);
                    purchaseNameFieldsContainer.appendChild(input);
                }
            } else if (totalQuantity > 10) {
                // Handled by disabling button and showing error in updatePurchaseSummary
                purchaseNameFieldsContainer.innerHTML = `<p class="text-red-600">${translations[currentLang].quantityError}</p>`;
            }
        }

        function handleProceedToPayment(event) {
            event.preventDefault();
            clearMessages(); // Clear previous errors

            const quantities = {
                full: parseInt(document.getElementById('quantity-full').value) || 0,
                discount: parseInt(document.getElementById('quantity-discount').value) || 0,
                free: parseInt(document.getElementById('quantity-free').value) || 0,
            };
            const totalQuantity = quantities.full + quantities.discount + quantities.free;
            const customerEmail = document.getElementById('purchase-email').value;
            const usageDate = document.getElementById('purchase-usage-date').value;

            const customerNames = [];
            let allNamesFilled = true;
            for (let i = 1; i <= totalQuantity; i++) {
                const nameInput = document.getElementById(`purchase_name_${i}`);
                if (nameInput && nameInput.value.trim()) {
                    customerNames.push(nameInput.value.trim());
                } else {
                    allNamesFilled = false;
                    if (nameInput) nameInput.focus();
                    break;
                }
            }

            // Validation
            if (totalQuantity <= 0 || totalQuantity > 10) {
                showError(translations[currentLang].quantityError, purchaseErrorDiv); return;
            }
            if (!allNamesFilled) {
                showError(translations[currentLang].fillNamesError, purchaseErrorDiv); return;
            }
            if (!customerEmail || !usageDate) {
                showError(translations[currentLang].fillFieldsError, purchaseErrorDiv); return;
            }
            if (new Date(usageDate) < new Date()) {
                showError(translations[currentLang].datePastError, purchaseErrorDiv); return;
            }


            // --- Payment Simulation ---
            setLoadingState(proceedBtn, true);
            console.log("Simulating payment...");
            // In a real app, redirect to payment gateway or show payment form here.
            // We'll just simulate success after a delay.
            setTimeout(() => {
                console.log("Payment simulation successful.");
                // Now call the actual backend purchase API
                submitPurchase({
                    attraction_id: currentAttractionId,
                    quantities: quantities,
                    customer_names: customerNames,
                    customer_email: customerEmail,
                    usage_date: usageDate
                });
                // Keep button loading until API call finishes
            }, 1500); // Simulate 1.5 second payment process
        }

        async function submitPurchase(purchaseData) {
            // setLoadingState(proceedBtn, true); // Already loading from simulation

            try {
                const response = await fetch(`${API_BASE_URL}/purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(purchaseData),
                });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.message || `HTTP error! status: ${response.status}`); }

                openModal(result.order_id, result.qr_data);
                // Reset form and go back to list view after success
                purchaseForm.reset();
                updatePurchaseSummary(); // Reset summary display
                showView('attraction-list-view'); // Go back to list

            } catch (error) {
                console.error('Purchase submission failed:', error);
                const failPrefix = translations[currentLang].purchaseFail;
                showError(`${failPrefix} ${error.message}`, purchaseErrorDiv); // Show error in purchase view
            } finally {
                setLoadingState(proceedBtn, false); // Re-enable button after API call
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const preferredLang = localStorage.getItem('preferredLang') || 'en';
            setLanguage(preferredLang);
            showView('attraction-list-view'); // Start at the list view
        });

    </script>

</body>

</html>